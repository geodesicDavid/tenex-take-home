# Story 2.1: Backend Calendar API Endpoint

## Status
Draft

## Story
**As a** developer,
**I want** to create a secure backend endpoint that retrieves calendar events using the Google Calendar API,
**so that** the frontend has a data source to display the user's calendar.

## Acceptance Criteria
1. A new, protected backend endpoint (e.g., `/api/calendar/events`) is created that requires an active user session.
2. The endpoint retrieves the user's stored refresh token from the secret manager to obtain a fresh access token for the Google API.
3. The endpoint successfully calls the Google Calendar API to fetch events for a relevant time period (e.g., the upcoming 7 days).
4. The fetched events are returned to the client in a structured, easy-to-use JSON format.

## Tasks / Subtasks
- [ ] Create protected calendar endpoint (AC: 1)
  - [ ] Implement `/api/calendar/events` endpoint with authentication middleware
  - [ ] Set up route protection using existing auth middleware
  - [ ] Configure endpoint to require active user session
- [ ] Implement token retrieval and refresh logic (AC: 2)
  - [ ] Create service to retrieve refresh token from Google Cloud Secret Manager
  - [ ] Implement OAuth 2.0 token refresh logic
  - [ ] Handle token expiration and renewal scenarios
- [ ] Integrate with Google Calendar API (AC: 3)
  - [ ] Create Google Calendar API client service
  - [ ] Implement API call to fetch events from primary calendar
  - [ ] Configure time range parameters (upcoming 7 days)
  - [ ] Handle API rate limits and errors
- [ ] Structure and return calendar events (AC: 4)
  - [ ] Transform Google Calendar API response to clean JSON format
  - [ ] Implement data validation and type checking
  - [ ] Add proper error handling and response formatting
  - [ ] Set up CORS headers for frontend access

## Dev Notes

### Previous Story Insights
Stories 1.1 (Project Initialization & Monorepo Setup) and 1.2 (Backend Google OAuth 2.0 Flow) must be completed first as they establish the backend foundation and authentication system with refresh token storage. [Source: docs/stories/1.1.project-initialization-monorepo-setup.story.md, docs/stories/1.2.backend-google-oauth-flow.story.md]

### Data Models
CalendarEvent model required for API response [Source: architecture/data-models.md#CalendarEvent]:
```typescript
interface CalendarEvent {
  id: string;           // The unique ID of the event
  summary: string;      // The title of the event
  start: Date;          // The start date and time of the event
  end: Date;            // The end date and time of the event
  description: string | null; // The description of the event
}
```

### API Specifications
CalendarService endpoint [Source: architecture/components.md#Backend-CalendarService]:
- **Responsibility**: Fetches calendar events from Google Calendar API using stored credentials
- **Key Interface**: Exposes the `/calendar/events` endpoint
- **Dependencies**: Google Calendar API

Google Calendar API endpoints [Source: architecture/external-apis.md#Google-Calendar-API]:
- `GET https://www.googleapis.com/calendar/v3/calendars/primary/events` - Get events from user's primary calendar
- **Authentication**: OAuth 2.0 with access token obtained via Google OAuth 2.0 API
- **Integration Notes**: Use stored refresh token to get fresh access token before making API calls

### Component Specifications
Backend: CalendarService [Source: architecture/components.md#Backend-CalendarService]:
- **Responsibility**: Fetches calendar events from Google Calendar API using user's stored credentials
- **Dependencies**: Google Calendar API
- **Technology Stack**: FastAPI

### File Locations
Based on unified project structure [Source: architecture/unified-project-structure.md]:
- Calendar endpoint: `apps/api/app/api/calendar.py`
- Calendar service: `apps/api/app/services/calendar_service.py`
- Calendar models: `apps/api/app/models/calendar.py`
- Secret manager integration: `apps/api/app/services/secret_manager.py` (extend existing)
- Shared types: `packages/shared/src/calendar.ts`

### Testing Requirements
Based on testing strategy [Source: architecture/testing-strategy.md#Backend-Tests]:
- Test file location: `apps/api/tests/`
- Test frameworks: Pytest
- Required tests:
  - Calendar endpoint authentication tests
  - Token refresh logic tests
  - Google Calendar API integration tests (mocked)
  - Data transformation and validation tests
  - Error handling and edge case tests

### Technical Constraints
- Must use FastAPI for backend [Source: architecture/tech-stack.md]
- Must use existing authentication middleware from Story 1.2 [Source: docs/stories/1.2.backend-google-oauth-flow.story.md]
- Must use Google Cloud Secret Manager for token storage [Source: architecture/external-apis.md]
- Must fetch events for upcoming 7 days timeframe
- Must return structured JSON matching CalendarEvent interface
- Must handle API rate limits and authentication errors
- Must use snake_case naming for Python functions [Source: architecture/coding-standards.md#Naming-Conventions]

## Testing
- Test file location: `apps/api/tests/test_calendar.py`
- Test standards: Follow backend testing patterns with Pytest
- Testing frameworks: Pytest
- Specific requirements:
  - Mock Google Calendar API responses
  - Test token refresh and expiration scenarios
  - Test authentication middleware integration
  - Test data transformation and validation
  - Test error handling for API failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-02 | 1.0 | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results