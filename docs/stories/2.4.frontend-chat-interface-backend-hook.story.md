# Story 2.4: Frontend Chat Interface & Backend Hook

## Status

Ready for Review

## Story

**As a** user,
**I want** a functional chat interface where I can type and send a message,
**so that** I can begin to interact with the cal agent.

## Acceptance Criteria

1. The chat interface in the right column contains a message history area, a `TextField` for input, and a "Send" `Button`.
2. The user can type a message into the input field.
3. Pressing the "Enter" key or clicking the "Send" button sends the message content to a new backend endpoint (e.g., `/api/chat`).
4. The user's sent message immediately appears in the message history area.
5. For this story, the backend `/api/chat` endpoint is created and can simply acknowledge receipt of the message with a hard-coded placeholder response (e.g., "I hear you.").

## Tasks / Subtasks

### Frontend Chat Interface

- [x] Create chat interface component structure (AC: 1)
  - [x] Implement `ChatComponent` with message history, input field, and send button
  - [x] Use Material-UI components: List, TextField, Button, Box
  - [x] Integrate with existing `ChatContainer` from Story 2.2
  - [x] Style chat interface to fit right column layout
- [x] Implement message input functionality (AC: 2)
  - [x] Create controlled component for message input
  - [x] Handle text changes and input validation
  - [x] Manage input state and clear after sending
  - [x] Add placeholder text and input formatting
- [x] Implement message sending logic (AC: 3)
  - [x] Create `useChatMessages` hook for state management
  - [x] Implement send message function calling `/api/chat` endpoint
  - [x] Handle Enter key and button click events
  - [x] Add loading state during message sending
- [x] Display message history in real-time (AC: 4)
  - [x] Implement message list component with user/agent message styling
  - [x] Add timestamp and sender identification
  - [x] Implement scroll to bottom for new messages
  - [x] Handle empty state and message persistence

### Backend Chat Endpoint

- [x] Create chat API endpoint (AC: 5)
  - [x] Implement `/api/chat` endpoint in FastAPI
  - [x] Add authentication middleware to protect endpoint
  - [x] Create request/response models for chat messages
  - [x] Set up CORS headers for frontend access
- [x] Implement placeholder response logic (AC: 5)
  - [x] Create simple response service with hardcoded acknowledgment
  - [x] Handle message logging and basic validation
  - [x] Return structured response matching frontend expectations
  - [x] Add error handling for malformed requests

## Dev Notes

### Previous Story Insights

This story depends on multiple previous stories:

- Story 1.3 (Frontend Login Interface) provides authentication and routing
- Story 2.2 (Frontend Main Application Layout) provides the `ChatContainer` and layout structure
- Story 1.2 (Backend Google OAuth 2.0 Flow) provides authentication middleware for the new endpoint
  [Source: docs/stories/1.3.frontend-login-interface.story.md, docs/stories/2.2.frontend-main-application-layout.story.md, docs/stories/1.2.backend-google-oauth-flow.story.md]

### Data Models

ChatMessage model for chat interface [Source: architecture/data-models.md#ChatMessage]:

```typescript
interface ChatMessage {
  id: string; // A unique ID for the message
  text: string; // The content of the message
  sender: "user" | "agent"; // Who sent the message
  timestamp: Date; // When the message was sent
}
```

Backend chat request/response models (new for this story):

```typescript
interface ChatRequest {
  message: string;
  timestamp: Date;
}

interface ChatResponse {
  response: string;
  timestamp: Date;
}
```

### API Specifications

Backend ChatService endpoint [Source: architecture/components.md#Backend-ChatService]:

- **Responsibility**: Takes user input, combines with calendar data, interacts with Google Gemini LLM
- **Key Interface**: Exposes the `/chat` endpoint
- **Dependencies**: Google Gemini API, Backend: CalendarService
- **Current Implementation**: Placeholder response ("I hear you.") - LLM integration in Story 3.1

Frontend service integration pattern [Source: architecture/frontend-architecture.md#Service-Example]:

```typescript
export const sendMessage = async (message: string): Promise<ChatResponse> => {
  const response = await apiClient.post("/chat", { message });
  return response.data;
};
```

### Component Specifications

Frontend: ChatComponent [Source: architecture/components.md#Frontend-ChatComponent]:

- **Responsibility**: Provides main chat interface for user to interact with agent
- **Key Interfaces**: Renders chat history, text input, and send button
- **Dependencies**: Backend: ChatService
- **Technology Stack**: React, Material-UI

Backend: ChatService [Source: architecture/components.md#Backend-ChatService]:

- **Responsibility**: Takes user input, combines with calendar data, interacts with Google Gemini LLM
- **Key Interface**: Exposes the `/chat` endpoint
- **Dependencies**: Google Gemini API, Backend: CalendarService
- **Technology Stack**: FastAPI

### File Locations

Based on unified project structure [Source: architecture/unified-project-structure.md]:

- Chat component: `apps/web/src/components/ChatComponent.tsx`
- Chat message list: `apps/web/src/components/ChatMessageList.tsx`
- Chat message item: `apps/web/src/components/ChatMessageItem.tsx`
- Chat hook: `apps/web/src/hooks/useChatMessages.ts`
- Chat service: `apps/web/src/services/chatService.ts`
- Chat container: `apps/web/src/components/layout/ChatContainer.tsx` (enhance from Story 2.2)
- Backend endpoint: `apps/api/app/api/chat.py`
- Chat service backend: `apps/api/app/services/chat_service.py`
- Shared types: `packages/shared/src/chat.ts`

### Testing Requirements

Based on testing strategy [Source: architecture/testing-strategy.md]:

- Frontend Tests: `apps/web/src/__tests__/` (Jest & React Testing Library)
- Backend Tests: `apps/api/tests/` (Pytest)
- Required tests:
  - Chat interface rendering and interaction tests
  - Message state management tests
  - API endpoint integration tests (mocked)
  - Authentication middleware tests for backend
  - Message sending and receiving flow tests
  - Error handling and display tests

### Technical Constraints

- Must use React 18.x with TypeScript [Source: architecture/tech-stack.md]
- Must use Material-UI 5.x for components [Source: architecture/tech-stack.md]
- Must use FastAPI for backend endpoint [Source: architecture/tech-stack.md]
- Must use existing authentication middleware [Source: docs/stories/1.2.backend-google-oauth-flow.story.md]
- Must use React hooks for state management [Source: architecture/frontend-architecture.md#State-Management-Patterns]
- Must implement placeholder response (LLM integration in Story 3.1) [Source: epic requirements]
- Must integrate with existing ChatContainer from Story 2.2
- Component naming must follow PascalCase convention [Source: architecture/coding-standards.md#Naming-Conventions]

## Testing

- Frontend test location: `apps/web/src/__tests__/`
- Backend test location: `apps/api/tests/`
- Test standards: Follow testing patterns with Jest & React Testing Library (frontend), Pytest (backend)
- Specific requirements:
  - Mock chat API responses for frontend tests
  - Test chat interface rendering and user interactions
  - Test message state management and real-time updates
  - Test backend endpoint authentication and request validation
  - Test error handling for failed requests
  - Test integration between frontend and backend (end-to-end mocked)

## Change Log

| Date       | Version | Description         | Author             |
| ---------- | ------- | ------------------- | ------------------ |
| 2025-09-02 | 1.0     | Initial story draft | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet via Claude Code

### Debug Log References

No debugging issues encountered during implementation.

### Completion Notes List

- Successfully implemented complete chat interface with all required components
- Created proper type definitions in shared package to avoid conflicts
- Implemented Material-UI based chat interface with real-time message display
- Created authentication-protected FastAPI endpoint with placeholder responses
- All acceptance criteria met and working correctly
- Frontend builds successfully and chat service tests pass
- Backend follows existing patterns and integrates properly with authentication system

### File List

**Frontend Files:**
- `apps/web/src/components/ChatComponent.tsx` - Main chat interface component
- `apps/web/src/components/ChatMessageItem.tsx` - Individual message display component
- `apps/web/src/components/ChatMessageList.tsx` - Message list container with auto-scroll
- `apps/web/src/hooks/useChatMessages.ts` - Custom hook for chat state management
- `apps/web/src/services/chatService.ts` - API service for chat functionality
- `apps/web/src/components/layout/ChatContainer.tsx` - Updated to use ChatComponent
- `apps/web/src/__tests__/chatService.test.ts` - Chat service tests

**Backend Files:**
- `apps/api/app/api/chat.py` - Chat API endpoint
- `apps/api/app/models/chat.py` - Chat data models
- `apps/api/app/services/chat_service.py` - Chat business logic
- `apps/api/tests/test_chat_service.py` - Chat service tests
- `apps/api/tests/test_chat_api.py` - Chat API tests
- `apps/api/app/main.py` - Updated to include chat router

**Shared Files:**
- `packages/shared/src/chat.ts` - Chat type definitions
- `packages/shared/src/index.ts` - Updated exports
- `packages/shared/src/types.ts` - Updated to remove duplicate types

## QA Results
