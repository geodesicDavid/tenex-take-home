# Story 1.2: Backend Google OAuth 2.0 Flow

## Status

Ready for Review

## Story

**As a** developer,
**I want** to implement the server-side Google OAuth 2.0 authentication flow,
**so that** the application can securely obtain permission to access a user's Google Calendar.

## Acceptance Criteria

1. The backend provides an endpoint that initiates the OAuth flow by redirecting the user to the Google OAuth 2.0 consent screen.
2. The backend correctly handles the callback from Google, exchanging the received authorization code for an access token and a refresh token.
3. The refresh token is securely stored in a designated secret manager (e.g., Google Cloud Secret Manager).
4. Upon successful authentication, a secure session (e.g., using an HTTP-only cookie) is created for the user to maintain their logged-in state.

## Tasks / Subtasks

- [x] Create OAuth initiation endpoint (AC: 1)
  - [x] Implement `/auth/google` endpoint that redirects to Google OAuth consent screen
  - [x] Configure OAuth 2.0 client ID and redirect URI
  - [x] Set up required scopes for Google Calendar access
- [x] Implement OAuth callback handler (AC: 2)
  - [x] Create `/auth/google/callback` endpoint to handle Google's response
  - [x] Exchange authorization code for access and refresh tokens
  - [x] Parse user information from Google's response
- [x] Set up secure token storage (AC: 3)
  - [x] Integrate with Google Cloud Secret Manager for refresh token storage
  - [x] Create service account and permissions for Secret Manager access
  - [x] Implement secure storage and retrieval logic
- [x] Create session management (AC: 4)
  - [x] Implement HTTP-only cookie-based session management
  - [x] Create user session data structure
  - [x] Set up session expiration and renewal logic
- [x] Add authentication middleware (AC: 4)
  - [x] Create dependency to check authenticated user
  - [x] Implement protected route middleware
  - [x] Add error handling for unauthenticated requests

## Dev Notes

### Previous Story Insights

Story 1.1 (Project Initialization & Monorepo Setup) must be completed first as it establishes the monorepo structure and backend application foundation. [Source: docs/stories/1.1.project-initialization-monorepo-setup.story.md]

### Data Models

User model required for authentication [Source: architecture/data-models.md#User]:

```typescript
interface User {
  id: string; // The user's unique Google ID
  email: string; // The user's email address
  name: string; // The user's full name
  picture: string; // URL to the user's profile picture
}
```

### API Specifications

AuthService endpoints [Source: architecture/components.md#Backend-AuthService]:

- `GET /auth/google` - Initiates OAuth flow by redirecting to Google
- `GET /auth/google/callback` - Handles OAuth callback from Google
- `GET /auth/logout` - Terminates user session

OAuth endpoints [Source: architecture/external-apis.md#Google-OAuth-20-API]:

- `GET https://accounts.google.com/o/oauth2/v2/auth` - Consent screen
- `POST https://oauth2.googleapis.com/token` - Token exchange

### Component Specifications

Backend: AuthService [Source: architecture/components.md#Backend-AuthService]:

- **Responsibility**: Handles Google OAuth 2.0 flow, manages user sessions, securely stores refresh tokens
- **Dependencies**: Google OAuth, Google Cloud Secret Manager
- **Technology Stack**: FastAPI

### File Locations

Based on unified project structure [Source: architecture/unified-project-structure.md]:

- Auth service: `apps/api/app/api/auth.py`
- Auth middleware: `apps/api/app/core/auth.py`
- User models: `apps/api/app/models/user.py`
- Secret manager service: `apps/api/app/services/secret_manager.py`
- Shared types: `packages/shared/src/auth.ts`

### Testing Requirements

Based on testing strategy [Source: architecture/testing-strategy.md#Backend-Tests]:

- Test file location: `apps/api/tests/`
- Test frameworks: Pytest
- Required tests:
  - OAuth flow integration tests
  - Token storage and retrieval tests
  - Session management tests
  - Authentication middleware tests

### Technical Constraints

- Must use FastAPI for backend [Source: architecture/tech-stack.md]
- Must use Google OAuth 2.0 for authentication [Source: architecture/tech-stack.md]
- Must use Google Cloud Secret Manager for token storage [Source: architecture/external-apis.md]
- Must use HTTP-only cookies for session management [Source: architecture/backend-architecture.md#Authentication-and-Authorization]
- Must implement middleware/guards for protected routes [Source: architecture/backend-architecture.md#MiddlewareGuards]

## Testing

- Test file location: `apps/api/tests/test_auth.py`
- Test standards: Follow backend testing patterns with Pytest
- Testing frameworks: Pytest
- Specific requirements:
  - Mock Google OAuth responses
  - Test token storage and retrieval
  - Test session creation and validation
  - Test authentication middleware

## Change Log

| Date       | Version | Description         | Author             |
| ---------- | ------- | ------------------- | ------------------ |
| 2025-09-02 | 1.0     | Initial story draft | Bob (Scrum Master) |
| 2025-09-08 | 1.1     | Implementation completed | James (Developer) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (Developer Agent)

### Debug Log References

- Implementation validation completed successfully
- All acceptance criteria met
- Comprehensive test coverage implemented

### Completion Notes List

- ✅ OAuth initiation endpoint (`/api/v1/auth/google`) implemented with proper redirect to Google consent screen
- ✅ OAuth callback handler (`/api/v1/auth/google/callback`) implemented with token exchange and user info parsing
- ✅ Google Cloud Secret Manager integration for secure refresh token storage
- ✅ HTTP-only cookie-based session management with expiration
- ✅ Authentication middleware for protected routes
- ✅ Comprehensive test suite with mocking for external dependencies
- ✅ Environment configuration and documentation provided
- ✅ Shared TypeScript types defined for frontend compatibility

### File List

**Backend Files:**
- `apps/api/app/core/config.py` - Configuration settings and environment variables
- `apps/api/app/core/auth.py` - Authentication service and session management
- `apps/api/app/core/middleware.py` - Authentication middleware
- `apps/api/app/api/auth.py` - Authentication endpoints
- `apps/api/app/models/user.py` - User data models
- `apps/api/app/services/secret_manager.py` - Google Cloud Secret Manager service
- `apps/api/app/main.py` - Updated main FastAPI application with auth integration
- `apps/api/.env.example` - Environment configuration example
- `apps/api/tests/test_auth.py` - Comprehensive authentication tests
- `apps/api/tests/conftest.py` - Test configuration and fixtures
- `apps/api/validate_implementation.py` - Implementation validation script

**Frontend Files:**
- `packages/shared/src/auth.ts` - Shared TypeScript types for authentication

**Configuration Files:**
- `apps/api/requirements.txt` - Updated Python dependencies

## QA Results
